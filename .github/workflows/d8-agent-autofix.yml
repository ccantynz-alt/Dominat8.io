name: d8-agent-autofix

on:
  workflow_dispatch:
  push:
    branches:
      - doctor/**
      - ops/**
      - main

permissions:
  contents: write

jobs:
  autofix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run agent autofix
        shell: pwsh
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File tools/agents/D8_AGENT_AUTOFIX.ps1 -RepoRoot $PWD

      - name: Commit + push branch (if any changes)
        id: commitpush
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "$(git status --porcelain)" ]]; then
            echo "NO_CHANGES=1" >> $GITHUB_ENV
            exit 0
          fi

          git config user.name "d8-agent"
          git config user.email "d8-agent@users.noreply.github.com"

          BR="agent/autofix-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BR" >> $GITHUB_ENV

          git checkout -b "$BR"
          git add -A
          git commit -m "agent: autofix tv routes + middleware + hygiene"
          git push --set-upstream origin "$BR"

      # IMPORTANT:
      # - Creating PRs with GITHUB_TOKEN can be blocked (403) in some org/repo settings.
      # - Use a PAT secret (fine-grained) instead: D8_AGENT_PAT
      - name: Create PR (best-effort; will NOT fail workflow)
        if: env.NO_CHANGES != '1'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.D8_AGENT_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const head  = process.env.BRANCH_NAME;

            if (!head) {
              core.notice("No BRANCH_NAME found; skipping PR creation.");
              return;
            }

            const repoInfo = await github.rest.repos.get({ owner, repo });
            const base = repoInfo.data.default_branch || "main";

            // If PR already exists for head->base, do nothing
            const prs = await github.rest.pulls.list({
              owner, repo, state: "open", head: `${owner}:${head}`
            });

            if (prs.data && prs.data.length > 0) {
              core.notice(`PR already exists: ${prs.data[0].html_url}`);
              return;
            }

            const pr = await github.rest.pulls.create({
              owner, repo,
              title: "agent: autofix tv routes + middleware + hygiene",
              body:  "Automated fixes from d8-agent-autofix workflow.",
              head, base
            });

            core.notice(`PR created: ${pr.data.html_url}`);