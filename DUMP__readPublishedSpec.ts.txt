// app/p/_lib/readPublishedSpec.ts
// STRICT + SAFE:
// - Do NOT import missing named exports from "@/lib/kv" (build fails if they donâ€™t exist).
// - Use a defensive dynamic import and probe for available getters.
// - Return null if KV is unavailable or spec isn't found.

type AnyObj = Record<string, any>;

async function getKvModule(): Promise<any | null> {
  try {
    // eslint-disable-next-line @typescript-eslint/no-var-requires
    const mod = await import("@/lib/kv");
    return mod as any;
  } catch {
    return null;
  }
}

async function tryGetJson(key: string): Promise<any | null> {
  const mod = await getKvModule();
  if (!mod) return null;

  // Common patterns weâ€™ve used across this repo historically.
  const candidateGetters: Array<(k: string) => Promise<any>> = [];

  // 1) named helpers
  if (typeof mod.kvGetJson === "function") candidateGetters.push((k) => mod.kvGetJson(k));
  if (typeof mod.kvGet === "function") candidateGetters.push((k) => mod.kvGet(k));
  if (typeof mod.getJson === "function") candidateGetters.push((k) => mod.getJson(k));
  if (typeof mod.get === "function") candidateGetters.push((k) => mod.get(k));

  // 2) exported kv client object (Upstash-style)
  if (mod.kv && typeof mod.kv.get === "function") candidateGetters.push((k) => mod.kv.get(k));
  if (mod.kv && typeof mod.kv.getJson === "function") candidateGetters.push((k) => mod.kv.getJson(k));

  // 3) default export that might be the kv client
  if (mod.default && typeof mod.default.get === "function") candidateGetters.push((k) => mod.default.get(k));
  if (mod.default && typeof mod.default.getJson === "function") candidateGetters.push((k) => mod.default.getJson(k));

  for (const getter of candidateGetters) {
    try {
      const v = await getter(key);

      if (v == null) continue;

      // If stored as JSON string, parse it.
      if (typeof v === "string") {
        try {
          return JSON.parse(v);
        } catch {
          // not JSON, but still a value
          return v;
        }
      }

      return v;
    } catch {
      // try next getter
      continue;
    }
  }

  return null;
}

/**
 * Read the published spec for a given project.
 * Returns the spec object (any) or null if not found.
 */
export async function readPublishedSpec(projectId: string): Promise<AnyObj | null> {
  // These keys are best-guess; try multiple to avoid "spec not found" during migrations.
  const keysToTry: string[] = [
    `project:${projectId}:published:spec`,
    `project:${projectId}:publishedSpec`,
    `projects:${projectId}:published:spec`,
    `projects:${projectId}:publishedSpec`,
    `published:${projectId}:spec`,
    `published:${projectId}`,
  ];

  for (const key of keysToTry) {
    const spec = await tryGetJson(key);
    if (spec && typeof spec === "object") return spec as AnyObj;
  }

  return null;
}

export default readPublishedSpec;
